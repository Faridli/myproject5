{% extends "dashboard/css.html" %}
{% load widget_tweaks %}
{% load dict_extras %}
{% block title %}All Forces{% endblock %}

{% block content %}

<main class="p-6 space-y-6">

<table class="bg-white table-auto w-full border">
<thead>
<tr class="bg-amber-400 text-3xl">
    <th>Ser</th>
    <th>Per No</th>
    <th>Rank</th>
    <th>Name</th>
    <th>Force</th>
    <th>Phone</th>
    <th>Email</th>
    <th>Company</th>
    <th>Detail</th>
    <th>Send</th>
</tr>
</thead>

<tbody>
{% for m in members %}
<tr class="text-center border text-2xl hover:bg-cyan-200 cursor-pointer">

    <td>{{ forloop.counter }}</td>
    <td>{{ m.no }}</td>
    <td>{{ m.rank }}</td>
    <td>{{ m.name }}</td>
    <td>{{ m.force }}</td>
    <td>{{ m.phone }}</td>
    <td>{{ m.email }}</td>

    <!-- Company column -->
    <td class="company-name">
        {{ m.company }}
    </td>

    <!-- View -->
    <td>
        <a href="{% url 'address' m.id %}" 
           class="bg-green-500 px-3 py-1 rounded hover:bg-amber-300">
           View
        </a>
    </td>

    <!-- AJAX Assign Form -->
    <td>
        <form class="assign-form">

            {% csrf_token %}
            {% with form=forms_dict|get_item:m.id %}
                {{ form.company }}
            {% endwith %}

            <input type="hidden" name="member_id" value="{{ m.id }}">

            <button type="button"
                class="assign-btn bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-700">
                Assign
            </button>

        </form>
    </td>

</tr>
{% endfor %}
</tbody>
</table>

</main>

<script>
document.querySelectorAll(".assign-btn").forEach(button => {
    button.addEventListener("click", function () {

        let form = this.closest(".assign-form");
        let row = this.closest("tr");
        let formData = new FormData(form);

        fetch("", {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest" },
            body: formData
        })
        .then(response => response.json())
        .then(data => {

            if (data.success) {

                // Update company instantly
                row.querySelector(".company-name").innerText = data.company_name;

                // Highlight row
                row.style.backgroundColor = "#d1fad1"; // light green
            }
        });
    });
});
</script>

{% endblock %}
